<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rest Express</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        
        .admin-header {
            background: #1f2937;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-link {
            color: #60a5fa;
            text-decoration: none;
            margin-left: 1rem;
        }
        
        .nav-link:hover {
            color: white;
        }
        
        .admin-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 2rem 0;
        }
        
        .sidebar-item {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .sidebar-item:hover,
        .sidebar-item.active {
            background: #2563eb;
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
        }
        
        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }
        
        .section {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section.active {
            display: block;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-shipped {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-delivered {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-cancelled {
            background: #fecaca;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="admin-title">Rest Express Admin</div>
        <nav>
            <a href="/" class="nav-link">View Store</a>
            <a href="/admin" class="nav-link">Dashboard</a>
            <button onclick="logout()" class="nav-link" style="background: none; border: none; cursor: pointer;">Logout</button>
        </nav>
    </header>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-item active" onclick="showSection('dashboard')">Dashboard</div>
            <div class="sidebar-item" onclick="showSection('products')">Products</div>
            <div class="sidebar-item" onclick="showSection('orders')">Orders</div>
            <div class="sidebar-item" onclick="showSection('categories')">Categories</div>
            <div class="sidebar-item" onclick="showSection('users')">Users</div>
            <div class="sidebar-item" onclick="showSection('deals')">Deals</div>
            <div class="sidebar-item" onclick="showSection('reviews')">Reviews</div>
            <div class="sidebar-item" onclick="showSection('analytics')">Analytics</div>
        </aside>

        <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h1 class="section-title">Dashboard Overview</h1>
                <div class="stats-grid" id="stats-grid">
                    <!-- Stats will be loaded here -->
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="section">
                <h1 class="section-title">Product Management</h1>
                <button class="btn" onclick="showAddProductModal()">Add New Product</button>
                <table class="table" id="products-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="section">
                <h1 class="section-title">Order Management</h1>
                <table class="table" id="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Categories Section -->
            <div id="categories" class="section">
                <h1 class="section-title">Category Management</h1>
                <button class="btn" onclick="showAddCategoryModal()">Add New Category</button>
                <table class="table" id="categories-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categories-tbody">
                        <!-- Categories will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Users Section -->
            <div id="users" class="section">
                <h1 class="section-title">User Management</h1>
                <button class="btn" onclick="showAddUserModal()">Add New User</button>
                <table class="table" id="users-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Deals Section -->
            <div id="deals" class="section">
                <h1 class="section-title">Deals Management</h1>
                <button class="btn" onclick="showAddDealModal()">Add New Deal</button>
                
                <div style="margin: 2rem 0;">
                    <h3>Deals Analytics</h3>
                    <div class="stats-grid" id="deals-stats" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <!-- Deals stats will be loaded here -->
                    </div>
                </div>

                <table class="table" id="deals-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Discount %</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Status</th>
                            <th>Orders</th>
                            <th>Revenue</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="deals-tbody">
                        <!-- Deals will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Reviews Section -->
            <div id="reviews" class="section">
                <h1 class="section-title">Reviews Management</h1>
                <div style="margin-bottom: 1rem;">
                    <button class="btn" onclick="loadPendingReviews()">Show Pending Reviews</button>
                    <button class="btn" style="background: #059669;" onclick="loadAllReviews()">Show All Reviews</button>
                </div>
                
                <table class="table" id="reviews-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Customer</th>
                            <th>Rating</th>
                            <th>Comment</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reviews-tbody">
                        <!-- Reviews will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="section">
                <h1 class="section-title">Analytics & Reports</h1>
                <div id="analytics-content">
                    <h3>Top Selling Products</h3>
                    <table class="table" id="top-products-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity Sold</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="top-products-tbody">
                            <!-- Top products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('add-product-modal')">&times;</button>
            <h2>Add New Product</h2>
            <form id="add-product-form">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-textarea" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Price</label>
                    <input type="number" name="price" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Stock</label>
                    <input type="number" name="stock" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Product Image</label>
                    <input type="file" id="product-image-upload" accept="image/*" class="form-input" style="padding: 0.5rem;">
                    <small style="color: #6b7280;">Or provide URL below:</small>
                    <input type="url" name="image" id="image-url-input" class="form-input" placeholder="https://example.com/image.jpg" style="margin-top: 0.5rem;">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select name="category" class="form-input" id="product-category-select" required>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                <button type="submit" class="btn">Add Product</button>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="add-category-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('add-category-modal')">&times;</button>
            <h2>Add New Category</h2>
            <form id="add-category-form">
                <div class="form-group">
                    <label class="form-label">Category Name</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-textarea" required></textarea>
                </div>
                <button type="submit" class="btn">Add Category</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('add-user-modal')">&times;</button>
            <h2>Add New User</h2>
            <form id="add-user-form">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select name="role" class="form-input" required>
                        <option value="customer">Customer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn">Add User</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('edit-user-modal')">&times;</button>
            <h2>Edit User</h2>
            <form id="edit-user-form">
                <input type="hidden" name="id" id="edit-user-id">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" name="name" id="edit-user-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" id="edit-user-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select name="role" id="edit-user-role" class="form-input" required>
                        <option value="customer">Customer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn">Update User</button>
            </form>
        </div>
    </div>

    <!-- Add Deal Modal -->
    <div id="add-deal-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('add-deal-modal')">&times;</button>
            <h2>Add New Deal</h2>
            <form id="add-deal-form">
                <div class="form-group">
                    <label class="form-label">Deal Title</label>
                    <input type="text" name="title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-textarea" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Discount Percentage</label>
                    <input type="number" name="discount" class="form-input" min="1" max="90" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="datetime-local" name="startDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="datetime-local" name="endDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Deal Type</label>
                    <select name="type" class="form-input" required>
                        <option value="percentage">Percentage Discount</option>
                        <option value="fixed">Fixed Amount</option>
                        <option value="bogo">Buy One Get One</option>
                    </select>
                </div>
                <button type="submit" class="btn">Add Deal</button>
            </form>
        </div>
    </div>

    <script>
        let categories = [];
        let products = [];
        let orders = [];
        let users = [];
        let isAuthenticated = false;

        // Simple admin authentication
        function checkAdminAuth() {
            const adminPassword = localStorage.getItem('adminAuth');
            if (adminPassword === 'admin123') {
                isAuthenticated = true;
                return true;
            }
            
            const password = prompt('Enter admin password:');
            if (password === 'admin123') {
                localStorage.setItem('adminAuth', 'admin123');
                isAuthenticated = true;
                return true;
            } else {
                alert('Access denied. Redirecting to store...');
                window.location.href = '/';
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            window.location.href = '/';
        }

        // Load initial data
        async function loadDashboard() {
            if (!checkAdminAuth()) return;
            
            await Promise.all([
                loadStats(),
                loadProducts(),
                loadOrders(),
                loadCategories(),
                loadUsers(),
                loadTopProducts(),
                loadDeals(),
                loadDealsAnalytics()
            ]);
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const stats = await response.json();
                
                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">$${stats.totalRevenue.toFixed(2)}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalOrders}</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalProducts}</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.pageViews}</div>
                        <div class="stat-label">Page Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.pendingOrders}</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalUsers}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                products = await response.json();
                
                document.getElementById('products-tbody').innerHTML = products.map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>$${product.price.toFixed(2)}</td>
                        <td>${product.stock}</td>
                        <td>${getCategoryName(product.category)}</td>
                        <td>
                            <button class="btn" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                orders = await response.json();
                
                document.getElementById('orders-tbody').innerHTML = orders.map(order => `
                    <tr>
                        <td>#${order.id}</td>
                        <td>${order.customerEmail || 'Guest'}</td>
                        <td>$${order.total.toFixed(2)}</td>
                        <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order.id}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                categories = await response.json();
                
                document.getElementById('categories-tbody').innerHTML = categories.map(category => `
                    <tr>
                        <td>${category.name}</td>
                        <td>${category.description}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteCategory('${category.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

                // Update category select in product form
                document.getElementById('product-category-select').innerHTML = categories.map(category => `
                    <option value="${category.id}">${category.name}</option>
                `).join('');
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                users = await response.json();
                
                document.getElementById('users-tbody').innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>
                            <button class="btn" onclick="editUser('${user.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function loadTopProducts() {
            try {
                const response = await fetch('/api/analytics/top-products?limit=10');
                const topProducts = await response.json();
                
                document.getElementById('top-products-tbody').innerHTML = topProducts.map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.revenue.toFixed(2)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load top products:', error);
            }
        }

        function getCategoryName(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            return category ? category.name : 'Unknown';
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked sidebar item
            event.target.classList.add('active');
        }

        function showAddProductModal() {
            document.getElementById('add-product-modal').style.display = 'block';
        }

        function showAddCategoryModal() {
            document.getElementById('add-category-modal').style.display = 'block';
        }

        function showAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'block';
        }

        function showAddDealModal() {
            document.getElementById('add-deal-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // User Management Functions
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-role').value = user.role;
                document.getElementById('edit-user-modal').style.display = 'block';
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await fetch(`/api/users/${userId}`, { method: 'DELETE' });
                    loadUsers();
                } catch (error) {
                    alert('Failed to delete user');
                }
            }
        }

        // Deals Management Functions
        let deals = [];

        async function loadDeals() {
            try {
                const response = await fetch('/api/deals');
                deals = await response.json();
                
                document.getElementById('deals-tbody').innerHTML = deals.map(deal => `
                    <tr>
                        <td>${deal.title}</td>
                        <td>${deal.discount}%</td>
                        <td>${new Date(deal.startDate).toLocaleDateString()}</td>
                        <td>${new Date(deal.endDate).toLocaleDateString()}</td>
                        <td><span class="status-badge ${deal.status}">${deal.status}</span></td>
                        <td>${deal.orders || 0}</td>
                        <td>$${(deal.revenue || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn" onclick="editDeal('${deal.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteDeal('${deal.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load deals:', error);
            }
        }

        async function loadDealsAnalytics() {
            try {
                const response = await fetch('/api/deals/analytics');
                const analytics = await response.json();
                
                document.getElementById('deals-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${analytics.activeDeals || 0}</div>
                        <div class="stat-label">Active Deals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${(analytics.dealsRevenue || 0).toFixed(2)}</div>
                        <div class="stat-label">Deals Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${analytics.dealsOrders || 0}</div>
                        <div class="stat-label">Orders from Deals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(analytics.avgDiscount || 0).toFixed(1)}%</div>
                        <div class="stat-label">Avg Discount</div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load deals analytics:', error);
            }
        }

        function editDeal(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (deal) {
                // Populate edit modal (would need to create edit deal modal)
                alert('Edit deal functionality - would open edit modal');
            }
        }

        async function deleteDeal(dealId) {
            if (confirm('Are you sure you want to delete this deal?')) {
                try {
                    await fetch(`/api/deals/${dealId}`, { method: 'DELETE' });
                    loadDeals();
                    loadDealsAnalytics();
                } catch (error) {
                    alert('Failed to delete deal');
                }
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                    loadProducts();
                } catch (error) {
                    alert('Failed to delete product');
                }
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadOrders();
            } catch (error) {
                alert('Failed to update order status');
            }
        }

        // Form submissions
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData);
            productData.price = parseFloat(productData.price);
            productData.stock = parseInt(productData.stock);

            try {
                await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                closeModal('add-product-modal');
                loadProducts();
                e.target.reset();
            } catch (error) {
                alert('Failed to add product');
            }
        });

        document.getElementById('add-category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const categoryData = Object.fromEntries(formData);

            try {
                await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });
                closeModal('add-category-modal');
                loadCategories();
                e.target.reset();
            } catch (error) {
                alert('Failed to add category');
            }
        });

        // Add User Form
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);

            try {
                await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                closeModal('add-user-modal');
                loadUsers();
                e.target.reset();
            } catch (error) {
                alert('Failed to add user');
            }
        });

        // Edit User Form
        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);
            const userId = userData.id;
            delete userData.id;

            try {
                await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                closeModal('edit-user-modal');
                loadUsers();
            } catch (error) {
                alert('Failed to update user');
            }
        });

        // Add Deal Form
        document.getElementById('add-deal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const dealData = Object.fromEntries(formData);
            dealData.discount = parseInt(dealData.discount);

            try {
                await fetch('/api/deals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dealData)
                });
                closeModal('add-deal-modal');
                loadDeals();
                loadDealsAnalytics();
                e.target.reset();
            } catch (error) {
                alert('Failed to add deal');
            }
        });

        // Reviews management functions
        async function loadAllReviews() {
            try {
                const response = await fetch('/api/reviews');
                const reviews = await response.json();
                displayReviews(reviews);
            } catch (error) {
                console.error('Failed to load reviews:', error);
            }
        }

        async function loadPendingReviews() {
            try {
                const response = await fetch('/api/reviews?status=pending');
                const reviews = await response.json();
                displayReviews(reviews.filter(r => !r.approved));
            } catch (error) {
                console.error('Failed to load pending reviews:', error);
            }
        }

        function displayReviews(reviews) {
            const tbody = document.getElementById('reviews-tbody');
            if (reviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No reviews found</td></tr>';
                return;
            }

            tbody.innerHTML = reviews.map(review => {
                const product = products.find(p => p.id === review.productId);
                return `
                    <tr>
                        <td>${product ? product.name : 'Unknown Product'}</td>
                        <td>${review.name}</td>
                        <td>${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${review.comment}</td>
                        <td>
                            <span class="status-badge ${review.approved ? 'approved' : 'pending'}">
                                ${review.approved ? 'Approved' : 'Pending'}
                            </span>
                        </td>
                        <td>${new Date(review.createdAt).toLocaleDateString()}</td>
                        <td>
                            ${!review.approved ? `<button class="btn" onclick="approveReview('${review.id}')">Approve</button>` : ''}
                            <button class="btn-danger" onclick="deleteReview('${review.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function approveReview(reviewId) {
            try {
                const response = await fetch(`/api/reviews/${reviewId}/approve`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    showSuccess('Review approved successfully');
                    loadPendingReviews();
                } else {
                    throw new Error('Failed to approve review');
                }
            } catch (error) {
                showError('Failed to approve review');
            }
        }

        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;

            try {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showSuccess('Review deleted successfully');
                    loadAllReviews();
                } else {
                    throw new Error('Failed to delete review');
                }
            } catch (error) {
                showError('Failed to delete review');
            }
        }

        // Enhanced image upload for products
        document.getElementById('product-image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // In a real app, you would upload to a file storage service
                // For demo purposes, we'll use a placeholder URL
                const imageUrl = `https://via.placeholder.com/300x200?text=${encodeURIComponent(file.name)}`;
                document.getElementById('image-url-input').value = imageUrl;
                showSuccess('Image uploaded successfully (demo mode)');
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', loadDashboard);

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>